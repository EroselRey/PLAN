<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Créateur de Plan Pro - Équipements Compresseur</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            overflow-x: auto;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .control-group {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .control-group h3 {
            color: #4a5568;
            margin-bottom: 15px;
            font-size: 18px;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 8px;
        }

        .input-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .input-row label {
            min-width: 120px;
            font-weight: 600;
            color: #4a5568;
        }

        input, select, button {
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);
        }

        .toolbar {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .tool-btn {
            padding: 8px 15px;
            font-size: 12px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .tool-btn.active {
            background: linear-gradient(135deg, #e53e3e, #c53030);
        }

        .workspace {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .canvas-container {
            position: relative;
            display: inline-block;
            overflow: auto;
            max-width: 100%;
            max-height: 70vh;
            border: 2px solid #4a5568;
            border-radius: 8px;
            background: #f7fafc;
        }

        #canvas {
            background: #f7fafc;
            cursor: crosshair;
            display: block;
        }

        .equipment-item {
            position: absolute;
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid #4299e1;
            border-radius: 8px;
            padding: 8px;
            cursor: move;
            font-size: 12px;
            font-weight: 600;
            text-align: center;
            user-select: none;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(5px);
            transition: all 0.2s ease;
            z-index: 10;
        }

        .equipment-item:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.3);
        }

        .equipment-item.selected {
            border-color: #e53e3e;
            background: rgba(229, 62, 62, 0.1);
        }

        .rotate-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 20px;
            height: 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: 2px solid white;
            border-radius: 50%;
            color: white;
            font-size: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            z-index: 15;
            transition: all 0.2s ease;
        }

        .rotate-btn:hover {
            transform: scale(1.2);
            background: linear-gradient(135deg, #5a67d8, #553c9a);
        }

        .compresseur { background: rgba(79, 172, 254, 0.9); }
        .secheur { background: rgba(79, 172, 254, 0.9); }
        .reservoir { background: rgba(129, 230, 217, 0.9); }
        .filtre { background: rgba(250, 202, 21, 0.9); }
        .purgeur { background: rgba(159, 122, 234, 0.9); }
        .separateur { background: rgba(255, 165, 0, 0.9); }
        .coude { background: rgba(160, 160, 160, 0.9); }
        .tee { background: rgba(200, 200, 200, 0.9); }

        .pipe {
            position: absolute;
            background: #2d3748;
            z-index: 5;
            cursor: pointer;
        }

        .pipe:hover {
            background: #4a5568;
        }

        .pipe.selected {
            background: #e53e3e;
        }

        .connection-point {
            position: absolute;
            width: 8px;
            height: 8px;
            background: #38a169;
            border: 2px solid white;
            border-radius: 50%;
            cursor: crosshair;
            z-index: 12;
            transform: translate(-50%, -50%);
        }

        .connection-point:hover {
            background: #2f855a;
            transform: translate(-50%, -50%) scale(1.5);
        }

        .distance-line {
            position: absolute;
            border-top: 2px dashed #e53e3e;
            transform-origin: left center;
            pointer-events: none;
            z-index: 8;
        }

        .distance-label {
            position: absolute;
            background: rgba(229, 62, 62, 0.9);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            pointer-events: none;
            z-index: 9;
            backdrop-filter: blur(5px);
        }

        .dimension-line {
            position: absolute;
            pointer-events: none;
            z-index: 7;
            background: #4a5568;
            height: 1px;
        }

        .dimension-label {
            position: absolute;
            background: white;
            border: 1px solid #4a5568;
            padding: 2px 6px;
            font-size: 10px;
            font-weight: bold;
            color: #4a5568;
            border-radius: 3px;
            transform: translate(-50%, -50%);
            z-index: 8;
        }

        .info-panel {
            margin-top: 20px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .delete-btn {
            background: linear-gradient(135deg, #e53e3e, #c53030);
            font-size: 12px;
            padding: 5px 10px;
            margin-left: 10px;
        }

        .clear-btn {
            background: linear-gradient(135deg, #e53e3e, #c53030);
            margin-left: 10px;
        }

        .scale-info {
            background: rgba(74, 85, 104, 0.9);
            color: white;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .zoom-controls {
            display: flex;
            gap: 10px;
        }

        .zoom-btn {
            padding: 5px 10px;
            font-size: 12px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            cursor: pointer;
            border-radius: 4px;
        }

        .zoom-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
        }

        .tab {
            padding: 8px 15px;
            background: rgba(255, 255, 255, 0.7);
            border: none;
            border-radius: 6px 6px 0 0;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .tab.active {
            background: rgba(255, 255, 255, 0.95);
            border-bottom: 2px solid #667eea;
        }

        .calculations-panel {
            background: rgba(129, 230, 217, 0.1);
            border: 1px solid rgba(129, 230, 217, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .calc-result {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .calc-result .label {
            font-weight: 600;
            color: #2d3748;
        }

        .calc-result .value {
            color: #1a202c;
            font-weight: bold;
        }

        .status-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(74, 85, 104, 0.95);
            color: white;
            padding: 8px 20px;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🏭 Créateur de Plan Pro - Installation Compresseur d'Air</h1>
            <p>Outil professionnel de conception avec tuyauterie intelligente, calculs automatiques et export PDF</p>
        </div>

        <div class="toolbar">
            <button class="tool-btn" id="selectTool" onclick="setTool('select')">🖱️ Sélection</button>
            <button class="tool-btn" id="pipeTool" onclick="setTool('pipe')">🔗 Tuyauterie</button>
            <button class="tool-btn" id="measureTool" onclick="setTool('measure')">📏 Mesure</button>
            <button class="tool-btn" id="dimensionTool" onclick="setTool('dimension')">📐 Cotation</button>
            <div style="border-left: 2px solid #e2e8f0; height: 30px; margin: 0 10px;"></div>
            <button class="tool-btn" onclick="saveProject()">💾 Sauvegarder</button>
            <button class="tool-btn" onclick="loadProject()">📂 Charger</button>
            <button class="tool-btn" onclick="exportPDF()">📄 Export PDF</button>
            <button class="tool-btn" onclick="showCalculations()">🔢 Calculs</button>
        </div>

        <div class="controls">
            <div class="control-group">
                <h3>📐 Dimensions du Local</h3>
                <div class="input-row">
                    <label>Largeur (m):</label>
                    <input type="number" id="roomWidth" value="10" min="1" step="0.5">
                </div>
                <div class="input-row">
                    <label>Hauteur (m):</label>
                    <input type="number" id="roomHeight" value="8" min="1" step="0.5">
                </div>
                <button onclick="updateCanvasSize()">📏 Mettre à jour le plan</button>
            </div>

            <div class="control-group">
                <h3>⚙️ Ajouter Équipement</h3>
                <div class="input-row">
                    <select id="equipmentType">
                        <option value="compresseur">🔧 Compresseur</option>
                        <option value="secheur">🌡️ Sécheur</option>
                        <option value="reservoir">🛢️ Réservoir</option>
                        <option value="filtre">🔍 Filtre</option>
                        <option value="purgeur">💧 Purgeur</option>
                        <option value="separateur">🌀 Séparateur de condensat</option>
                        <option value="coude">↩️ Coude</option>
                        <option value="tee">🔀 T</option>
                    </select>
                    <input type="text" id="equipmentName" placeholder="Nom de l'équipement">
                </div>
                <div class="input-row">
                    <label>Largeur (mm):</label>
                    <input type="number" id="equipmentWidth" value="800" min="100" step="50" style="flex: 1;">
                </div>
                <div class="input-row">
                    <label>Profondeur (mm):</label>
                    <input type="number" id="equipmentDepth" value="600" min="100" step="50" style="flex: 1;">
                </div>
                <div class="input-row" id="flowRow">
                    <label>Débit (m³/h):</label>
                    <input type="number" id="equipmentFlow" value="100" min="0" step="10" style="flex: 1;">
                </div>
                <div class="input-row" id="capacityRow" style="display: none;">
                    <label>Capacité (L):</label>
                    <input type="number" id="equipmentCapacity" value="500" min="0" step="50" style="flex: 1;">
                </div>
                <button onclick="addEquipment()">➕ Ajouter</button>
                <button onclick="clearAll()" class="clear-btn">🗑️ Tout effacer</button>
            </div>

            <div class="control-group">
                <h3>🔗 Tuyauterie Intelligente</h3>
                <div class="input-row">
                    <label>Matériau:</label>
                    <select id="pipeMaterial">
                        <option value="galvanise">Galvanisé (v≤15m/s)</option>
                        <option value="airnet" selected>AIRnet Alu (v≤20m/s)</option>
                        <option value="inox">AIRnet Inox (v≤25m/s)</option>
                    </select>
                </div>
                <div class="input-row">
                    <label>Pression (bar):</label>
                    <select id="pipePressure">
                        <option value="7">7 bar</option>
                        <option value="8" selected>8 bar</option>
                        <option value="10">10 bar</option>
                        <option value="12">12 bar</option>
                    </select>
                </div>
                <div class="input-row">
                    <label>Type:</label>
                    <select id="pipeType">
                        <option value="air">Air comprimé</option>
                        <option value="condensat">Évacuation condensat</option>
                    </select>
                </div>
                <div id="pipeRecommendation" style="margin-top: 10px; padding: 10px; background: #e6fffa; border-radius: 6px; font-size: 12px;">
                    <strong>💡 Recommandation :</strong> <span id="recommendationText">Sélectionnez deux équipements pour voir la recommandation</span>
                </div>
                <button onclick="clearPipes()">🗑️ Effacer tuyauterie</button>
            </div>

            <div class="control-group">
                <h3>📊 Outils CAO</h3>
                <button onclick="clearDistances()">🗑️ Effacer mesures</button>
                <button onclick="clearDimensions()">🗑️ Effacer cotations</button>
                <div style="margin: 10px 0; padding: 8px; background: #fffbeb; border-radius: 4px; font-size: 12px;">
                    <strong>📐 Mesure :</strong> Cliquez sur un mur puis un équipement pour mesurer la distance au mur, ou cliquez sur deux équipements pour mesurer entre eux
                </div>
                <button onclick="snapToGrid()">⚡ Aligner sur grille</button>
                <button onclick="optimizeLayout()">🎯 Optimiser disposition</button>
            </div>
        </div>

        <div class="workspace">
            <div class="scale-info" id="scaleInfo">
                <span>Échelle: 1 pixel = 0.02 m | Zoom: 100%</span>
                <div class="zoom-controls">
                    <button class="zoom-btn" onclick="zoomIn()">🔍+</button>
                    <button class="zoom-btn" onclick="zoomOut()">🔍-</button>
                    <button class="zoom-btn" onclick="resetZoom()">🎯</button>
                </div>
            </div>
            <div class="canvas-container" id="canvasContainer">
                <canvas id="canvas" width="500" height="400"></canvas>
            </div>
        </div>

        <div class="info-panel">
            <div class="tabs">
                <button class="tab active" onclick="showTab('equipment')">📋 Équipements</button>
                <button class="tab" onclick="showTab('pipes')">🔗 Tuyauterie</button>
                <button class="tab" onclick="showTab('calculations')">🔢 Calculs</button>
            </div>
            
            <div id="equipmentTab" class="tab-content">
                <h3>📋 Équipements placés</h3>
                <div id="equipmentList"></div>
            </div>
            
            <div id="pipesTab" class="tab-content" style="display: none;">
                <h3>🔗 Réseau de tuyauterie</h3>
                <div id="pipesList"></div>
            </div>
            
            <div id="calculationsTab" class="tab-content" style="display: none;">
                <h3>🔢 Calculs techniques</h3>
                <div class="calculations-panel" id="calculationsPanel">
                    <div class="calc-result">
                        <span class="label">Surface totale occupée:</span>
                        <span class="value" id="totalArea">0 m²</span>
                    </div>
                    <div class="calc-result">
                        <span class="label">Débit total compresseurs:</span>
                        <span class="value" id="totalCompressorFlow">0 m³/h</span>
                    </div>
                    <div class="calc-result">
                        <span class="label">Capacité de stockage:</span>
                        <span class="value" id="totalStorage">0 L</span>
                    </div>
                    <div class="calc-result">
                        <span class="label">Longueur de tuyauterie:</span>
                        <span class="value" id="totalPipeLength">0 m</span>
                    </div>
                    <div class="calc-result">
                        <span class="label">Nombre d'équipements:</span>
                        <span class="value" id="equipmentCount">0</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Input file caché pour charger -->
    <input type="file" id="fileInput" accept=".json" style="display: none;" onchange="handleFileLoad(event)">

    <div class="status-bar">
        <span id="statusText">Prêt - Sélectionnez un outil</span>
        <span id="mousePos">Position: 0,0 m</span>
    </div>

    <script>
        // Variables globales
        let canvas = document.getElementById('canvas');
        let ctx = canvas.getContext('2d');
        let canvasContainer = document.getElementById('canvasContainer');
        let equipment = [];
        let pipes = [];
        let selectedEquipment = [];
        let selectedPipes = [];
        let draggedItem = null;
        let scale = 50;
        let zoom = 1;
        let currentTool = 'select';
        let pipeStart = null;

        // Projet
        let project = {
            name: 'Nouveau projet',
            created: new Date(),
            modified: new Date(),
            equipment: [],
            pipes: [],
            settings: {}
        };

        // Fonctions utilitaires
        function calculatePipeDiameter(flow, length, material, pressure) {
            const maxVelocities = {
                'galvanise': 15,
                'airnet': 20,
                'inox': 25
            };
            
            const diameters = [20, 25, 32, 40, 50, 65, 80, 100];
            const maxVel = maxVelocities[material];
            const flowM3s = flow / 3600;
            const minDiameter = Math.sqrt((4 * flowM3s) / (Math.PI * maxVel)) * 1000;
            const recommendedDiameter = diameters.find(d => d >= minDiameter) || diameters[diameters.length - 1];
            const actualVelocity = (4 * flowM3s) / (Math.PI * Math.pow(recommendedDiameter / 1000, 2));
            const pressureLoss = (actualVelocity * actualVelocity * 0.1 * length) / 100;
            
            return {
                diameter: recommendedDiameter,
                velocity: actualVelocity.toFixed(1),
                pressureLoss: pressureLoss.toFixed(1),
                material: material
            };
        }

        function getCompressorFlow() {
            return equipment
                .filter(eq => eq.type === 'compresseur')
                .reduce((sum, eq) => sum + (eq.flow || 0), 0);
        }

        // Gestion des outils
        function setTool(tool) {
            currentTool = tool;
            document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
            const toolBtn = document.getElementById(tool + 'Tool');
            if (toolBtn) toolBtn.classList.add('active');
            
            // Nettoyer les sélections précédentes
            selectedEquipment = [];
            selectedWallPoint = null;
            removeWallPointVisual();
            document.querySelectorAll('.equipment-item').forEach(el => 
                el.classList.remove('selected'));
            
            const toolNames = {
                'select': 'Sélection',
                'pipe': 'Tuyauterie - Cliquez sur les équipements pour connecter',
                'measure': 'Mesure - Cliquez sur un mur puis un équipement, ou sur deux équipements',
                'dimension': 'Cotation - Cliquez pour ajouter des cotes'
            };
            
            const statusText = document.getElementById('statusText');
            if (statusText) statusText.textContent = toolNames[tool] || 'Outil sélectionné';
            
            canvas.style.cursor = tool === 'pipe' ? 'crosshair' : (tool === 'select' ? 'default' : 'crosshair');
        }

        // Gestion du canvas
        function updateCanvasSize() {
            const width = parseFloat(document.getElementById('roomWidth').value);
            const height = parseFloat(document.getElementById('roomHeight').value);
            
            const baseScale = 50;
            canvas.width = width * baseScale * zoom;
            canvas.height = height * baseScale * zoom;
            scale = baseScale * zoom;
            
            const scaleInfoSpan = document.querySelector('#scaleInfo span');
            if (scaleInfoSpan) {
                scaleInfoSpan.textContent = `Échelle: 1 pixel = ${(1/scale).toFixed(3)} m | Zoom: ${Math.round(zoom * 100)}%`;
            }
            
            drawRoom();
            redrawAll();
            updateCalculations();
        }

        function zoomIn() {
            zoom *= 1.2;
            updateCanvasSize();
        }

        function zoomOut() {
            zoom /= 1.2;
            updateCanvasSize();
        }

        function resetZoom() {
            zoom = 1;
            updateCanvasSize();
        }

        function drawRoom() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Grille
            ctx.strokeStyle = '#e2e8f0';
            ctx.lineWidth = 1;
            
            const gridSize = scale / 2;
            for (let x = 0; x <= canvas.width; x += gridSize) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvas.height);
                ctx.stroke();
            }
            
            for (let y = 0; y <= canvas.height; y += gridSize) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(canvas.width, y);
                ctx.stroke();
            }
            
            // Contour de la pièce
            ctx.strokeStyle = '#2d3748';
            ctx.lineWidth = 3;
            ctx.strokeRect(0, 0, canvas.width, canvas.height);
            
            // Mesures
            ctx.fillStyle = '#4a5568';
            ctx.font = `${Math.max(10, 12 * zoom)}px Arial`;
            
            const width = parseFloat(document.getElementById('roomWidth').value);
            const height = parseFloat(document.getElementById('roomHeight').value);
            
            for (let i = 0; i <= width; i += 1) {
                const x = i * scale;
                ctx.fillText(i + 'm', x - 8, canvas.height + 15);
            }
            
            for (let i = 0; i <= height; i += 1) {
                const y = i * scale;
                ctx.save();
                ctx.translate(-15, y + 4);
                ctx.fillText(i + 'm', 0, 0);
                ctx.restore();
            }
        }

        // Gestion des équipements
        function addEquipment() {
            const type = document.getElementById('equipmentType').value;
            const name = document.getElementById('equipmentName').value || type;
            const widthMm = parseFloat(document.getElementById('equipmentWidth').value);
            const depthMm = parseFloat(document.getElementById('equipmentDepth').value);
            
            let flow = 0;
            let capacity = 0;
            
            if (type === 'compresseur') {
                const flowInput = document.getElementById('equipmentFlow');
                flow = flowInput ? parseFloat(flowInput.value) || 0 : 0;
            } else if (type === 'reservoir') {
                const capacityInput = document.getElementById('equipmentCapacity');
                capacity = capacityInput ? parseFloat(capacityInput.value) || 0 : 0;
            }
            
            let connectionSides;
            if (type === 'coude') {
                connectionSides = ['left', 'bottom'];
            } else if (type === 'tee') {
                connectionSides = ['left', 'right', 'top'];
            }

            const newEquipment = {
                id: Date.now(),
                type: type,
                name: name,
                x: 50,
                y: 50,
                width: (widthMm / 1000) * scale,
                height: (depthMm / 1000) * scale,
                widthMm: widthMm,
                depthMm: depthMm,
                rotation: 0,
                flow: flow,
                capacity: capacity,
                connectionSides: connectionSides,
                connections: []
            };
            
            equipment.push(newEquipment);
            createEquipmentElement(newEquipment);
            updateEquipmentList();
            updateCalculations();
            
            // Nettoyer le champ nom
            const nameInput = document.getElementById('equipmentName');
            if (nameInput) nameInput.value = '';
        }

        function createEquipmentElement(eq) {
            const div = document.createElement('div');
            div.className = `equipment-item ${eq.type}`;
            div.id = `eq-${eq.id}`;
            div.style.left = eq.x + 'px';
            div.style.top = eq.y + 'px';
            div.style.width = eq.width + 'px';
            div.style.height = eq.height + 'px';
            div.style.transform = `rotate(${eq.rotation || 0}deg)`;
            div.style.transformOrigin = 'center center';
            div.style.background = 'transparent';
            div.style.border = 'none';
            
            // Créer la forme SVG selon le type d'équipement
            div.innerHTML = createEquipmentSVG(eq);
            
            // Bouton de rotation
            const rotateBtn = document.createElement('div');
            rotateBtn.className = 'rotate-btn';
            rotateBtn.innerHTML = '↻';
            rotateBtn.title = 'Faire tourner (90°)';
            rotateBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                rotateEquipment(eq.id);
            });
            
            div.appendChild(rotateBtn);
            
            // Points de connexion
            createConnectionPoints(div, eq);
            
            div.addEventListener('mousedown', startDrag);
            div.addEventListener('click', handleEquipmentClick);
            
            canvasContainer.appendChild(div);
        }

        function createEquipmentSVG(eq) {
            const width = eq.width;
            const height = eq.height;
            
            switch(eq.type) {
                case 'compresseur':
                    return `
                        <svg width="100%" height="100%" viewBox="0 0 ${width} ${height}">
                            <!-- Caisse principale -->
                            <rect x="5" y="10" width="${width-10}" height="${height-20}"
                                  fill="#3498db" stroke="#2980b9" stroke-width="2" rx="4"/>
                            
                            <!-- Grilles de ventilation -->
                            ${Array.from({length: Math.floor(height/20)}, (_, i) => 
                                `<rect x="10" y="${15 + i*15}" width="${width-20}" height="3" fill="#34495e" opacity="0.7"/>`
                            ).join('')}
                            
                            <!-- Contrôleur -->
                            <rect x="${width-35}" y="15" width="25" height="35" 
                                  fill="#2c3e50" stroke="#1a252f" stroke-width="1" rx="2"/>
                            <circle cx="${width-22}" cy="25" r="3" fill="#e67e22"/>
                            <circle cx="${width-22}" cy="35" r="3" fill="#27ae60"/>
                            
                            <!-- Sortie d'air -->
                            <circle cx="${width/2}" cy="5" r="8" fill="#95a5a6" stroke="#7f8c8d" stroke-width="2"/>
                            
                            <text x="${width/2}" y="${height-5}" text-anchor="middle" font-size="10" font-weight="bold" fill="#2c3e50">${eq.name}</text>
                        </svg>`;
                        
                case 'reservoir':
                    return `
                        <svg width="100%" height="100%" viewBox="0 0 ${width} ${height}">
                            <!-- Corps cylindrique -->
                            <ellipse cx="${width/2}" cy="${height/2}" rx="${width/2-5}" ry="${height/2-10}" 
                                     fill="#3498db" stroke="#2980b9" stroke-width="3"/>
                            
                            <!-- Reflet -->
                            <ellipse cx="${width/2}" cy="${height/2-5}" rx="${width/2-15}" ry="${height/2-20}" 
                                     fill="none" stroke="#74b9ff" stroke-width="2" opacity="0.6"/>
                            
                            <!-- Vanne de purge -->
                            <rect x="${width/2-3}" y="${height-8}" width="6" height="8" fill="#7f8c8d"/>
                            
                            <!-- Manomètre -->
                            <circle cx="${width-15}" cy="20" r="8" fill="#f8f9fa" stroke="#495057" stroke-width="1"/>
                            <line x1="${width-15}" y1="20" x2="${width-10}" y2="15" stroke="#e74c3c" stroke-width="2"/>
                            
                            <text x="${width/2}" y="${height-5}" text-anchor="middle" font-size="10" font-weight="bold" fill="#2c3e50">${eq.name}</text>
                        </svg>`;
                        
                case 'secheur':
                    return `
                        <svg width="100%" height="100%" viewBox="0 0 ${width} ${height}">
                            <!-- Caisse -->
                            <rect x="5" y="5" width="${width-10}" height="${height-10}" 
                                  fill="#3498db" stroke="#2980b9" stroke-width="2" rx="6"/>
                            
                            <!-- Échangeurs (lignes diagonales) -->
                            ${Array.from({length: Math.floor(width/8)}, (_, i) => 
                                `<line x1="${10 + i*8}" y1="10" x2="${10 + i*8}" y2="${height-10}" 
                                       stroke="#74b9ff" stroke-width="1" opacity="0.7"/>`
                            ).join('')}
                            
                            <!-- Évacuation condensats -->
                            <rect x="${width/2-5}" y="${height-8}" width="10" height="8" fill="#95a5a6"/>
                            <circle cx="${width/2}" cy="${height-4}" r="2" fill="#7f8c8d"/>
                            
                            <!-- Entrée/Sortie air -->
                            <circle cx="15" cy="${height/2}" r="6" fill="#ecf0f1" stroke="#bdc3c7" stroke-width="2"/>
                            <circle cx="${width-15}" cy="${height/2}" r="6" fill="#ecf0f1" stroke="#bdc3c7" stroke-width="2"/>
                            
                            <text x="${width/2}" y="${height-5}" text-anchor="middle" font-size="10" font-weight="bold" fill="#2c3e50">${eq.name}</text>
                        </svg>`;
                        
                case 'filtre':
                    return `
                        <svg width="100%" height="100%" viewBox="0 0 ${width} ${height}">
                            <!-- Bol transparent -->
                            <ellipse cx="${width/2}" cy="${height-20}" rx="${width/2-5}" ry="15" 
                                     fill="#ecf0f1" stroke="#bdc3c7" stroke-width="2" opacity="0.8"/>
                            
                            <!-- Tête de filtre -->
                            <rect x="10" y="5" width="${width-20}" height="25" 
                                  fill="#f39c12" stroke="#e67e22" stroke-width="2" rx="4"/>
                            
                            <!-- Cartouche filtrante -->
                            <rect x="15" y="35" width="${width-30}" height="${height-60}" 
                                  fill="#fff3cd" stroke="#ffeaa7" stroke-width="1"/>
                            
                            <!-- Lignes du média filtrant -->
                            ${Array.from({length: Math.floor((height-60)/8)}, (_, i) => 
                                `<line x1="15" y1="${40 + i*8}" x2="${width-15}" y2="${40 + i*8}" 
                                       stroke="#e17055" stroke-width="1" opacity="0.5"/>`
                            ).join('')}
                            
                            <!-- Purge -->
                            <rect x="${width/2-3}" y="${height-15}" width="6" height="10" fill="#95a5a6"/>
                            
                            <text x="${width/2}" y="${height-2}" text-anchor="middle" font-size="10" font-weight="bold" fill="#2c3e50">${eq.name}</text>
                        </svg>`;
                        
                case 'purgeur':
                    return `
                        <svg width="100%" height="100%" viewBox="0 0 ${width} ${height}">
                            <!-- Corps principal compact -->
                            <ellipse cx="${width/2}" cy="${height/2-5}" rx="${width/2-5}" ry="${height/2-10}" 
                                     fill="#9b59b6" stroke="#8e44ad" stroke-width="2"/>
                            
                            <!-- Chambre interne -->
                            <circle cx="${width/2}" cy="${height/2-5}" r="${Math.min(width, height)/4}" 
                                    fill="#ecf0f1" stroke="#bdc3c7" stroke-width="1"/>
                            
                            <!-- Flotteur -->
                            <circle cx="${width/2}" cy="${height/2-5}" r="${Math.min(width, height)/8}" 
                                    fill="#f39c12"/>
                            
                            <!-- Sortie condensats -->
                            <rect x="${width/2-4}" y="${height-10}" width="8" height="10" fill="#7f8c8d"/>
                            
                            <text x="${width/2}" y="${height-2}" text-anchor="middle" font-size="9" font-weight="bold" fill="#2c3e50">${eq.name}</text>
                        </svg>`;
                        
                case 'separateur':
                    return `
                        <svg width="100%" height="100%" viewBox="0 0 ${width} ${height}">
                            <!-- Chambre de séparation (forme cyclone) -->
                            <ellipse cx="${width/2}" cy="25" rx="${width/2-5}" ry="20"
                                     fill="#e67e22" stroke="#d35400" stroke-width="2"/>
                            
                            <!-- Cône de séparation -->
                            <polygon points="${width/2-15},45 ${width/2+15},45 ${width/2},${height-25}" 
                                     fill="#f39c12" stroke="#e67e22" stroke-width="2"/>
                            
                            <!-- Bac de récupération -->
                            <rect x="15" y="${height-20}" width="${width-30}" height="15" 
                                  fill="#95a5a6" stroke="#7f8c8d" stroke-width="2" rx="3"/>
                            
                            <!-- Entrée tangentielle -->
                            <circle cx="10" cy="25" r="5" fill="#ecf0f1" stroke="#bdc3c7" stroke-width="2"/>
                            
                            <!-- Sortie air propre -->
                            <circle cx="${width-10}" cy="15" r="5" fill="#ecf0f1" stroke="#bdc3c7" stroke-width="2"/>
                            
                            <text x="${width/2}" y="${height-2}" text-anchor="middle" font-size="9" font-weight="bold" fill="#2c3e50">${eq.name}</text>
                        </svg>`;

                case 'coude':
                    return `
                        <svg width="100%" height="100%" viewBox="0 0 ${width} ${height}">
                            <path d="M ${width*0.2} ${height*0.8} V ${height*0.2} H ${width*0.8}" fill="none" stroke="#2d3748" stroke-width="8"/>
                            <text x="${width/2}" y="${height-2}" text-anchor="middle" font-size="10" font-weight="bold" fill="#2c3e50">${eq.name}</text>
                        </svg>`;

                case 'tee':
                    return `
                        <svg width="100%" height="100%" viewBox="0 0 ${width} ${height}">
                            <path d="M ${width/2} ${height*0.2} V ${height*0.8}" fill="none" stroke="#2d3748" stroke-width="8"/>
                            <path d="M ${width*0.2} ${height/2} H ${width*0.8}" fill="none" stroke="#2d3748" stroke-width="8"/>
                            <text x="${width/2}" y="${height-2}" text-anchor="middle" font-size="10" font-weight="bold" fill="#2c3e50">${eq.name}</text>
                        </svg>`;
                        
                default:
                    return `
                        <svg width="100%" height="100%" viewBox="0 0 ${width} ${height}">
                            <rect x="5" y="5" width="${width-10}" height="${height-10}" 
                                  fill="#95a5a6" stroke="#7f8c8d" stroke-width="2" rx="4"/>
                            <text x="${width/2}" y="${height/2}" text-anchor="middle" font-size="12" font-weight="bold" fill="#2c3e50">${eq.name}</text>
                        </svg>`;
            }
        }

        function createConnectionPoints(element, eq) {
            const allPositions = {
                top: { x: '50%', y: '0%', side: 'top' },
                right: { x: '100%', y: '50%', side: 'right' },
                bottom: { x: '50%', y: '100%', side: 'bottom' },
                left: { x: '0%', y: '50%', side: 'left' }
            };

            const sides = eq.connectionSides || ['top','right','bottom','left'];

            sides.forEach(side => {
                const pos = allPositions[side];
                const point = document.createElement('div');
                point.className = 'connection-point';
                point.style.left = pos.x;
                point.style.top = pos.y;
                point.dataset.equipmentId = eq.id;
                point.dataset.side = pos.side;

                point.addEventListener('click', function(e) {
                    e.stopPropagation();
                    handleConnectionClick(eq.id, pos.side, e);
                });

                element.appendChild(point);
            });
        }

        function rotateEquipment(id) {
            const eq = equipment.find(e => e.id === id);
            if (!eq) return;
            
            eq.rotation = (eq.rotation || 0) + 90;
            if (eq.rotation >= 360) eq.rotation = 0;
            
            const element = document.getElementById(`eq-${id}`);
            if (element) {
                element.style.transform = `rotate(${eq.rotation}deg)`;
                
                if (eq.rotation === 90 || eq.rotation === 270) {
                    element.style.width = ((eq.depthMm / 1000) * scale) + 'px';
                    element.style.height = ((eq.widthMm / 1000) * scale) + 'px';
                } else {
                    element.style.width = ((eq.widthMm / 1000) * scale) + 'px';
                    element.style.height = ((eq.depthMm / 1000) * scale) + 'px';
                }
            }
            
            redrawPipesForEquipment(id);
            updateEquipmentList();
        }

        // Gestion de la tuyauterie
        function handleConnectionClick(equipmentId, side, event) {
            if (currentTool !== 'pipe') return;
            
            const eq = equipment.find(e => e.id === equipmentId);
            if (!eq) return;
            
            const statusText = document.getElementById('statusText');
            
            if (!pipeStart) {
                pipeStart = { equipmentId, side, eq };
                if (statusText) statusText.textContent = 'Cliquez sur un autre point de connexion';
            } else {
                if (pipeStart.equipmentId !== equipmentId) {
                    createPipe(pipeStart, { equipmentId, side, eq });
                    if (statusText) statusText.textContent = 'Tuyau créé - Cliquez pour en créer un autre';
                }
                pipeStart = null;
            }
        }

        function createPipe(start, end) {
            const startPos = getConnectionPosition(start.eq, start.side);
            const endPos = getConnectionPosition(end.eq, end.side);
            const length = Math.sqrt((endPos.x - startPos.x) ** 2 + (endPos.y - startPos.y) ** 2) / scale;
            
            const compressorFlow = getCompressorFlow();
            const material = document.getElementById('pipeMaterial').value;
            const pressure = parseInt(document.getElementById('pipePressure').value);
            
            const recommendation = calculatePipeDiameter(compressorFlow, length, material, pressure);
            
            const pipe = {
                id: Date.now(),
                startEquipment: start.equipmentId,
                endEquipment: end.equipmentId,
                startSide: start.side,
                endSide: end.side,
                diameter: recommendation.diameter,
                type: document.getElementById('pipeType').value,
                material: material,
                pressure: pressure,
                length: length,
                flow: compressorFlow,
                velocity: recommendation.velocity,
                pressureLoss: recommendation.pressureLoss
            };
            
            pipes.push(pipe);
            drawPipe(pipe);
            updatePipesList();
            updateCalculations();
            
            const recommendationTextEl = document.getElementById('recommendationText');
            if (recommendationTextEl) {
                recommendationTextEl.innerHTML = 
                    `Ø${recommendation.diameter}mm ${material} - Vitesse: ${recommendation.velocity}m/s - Perte: ${recommendation.pressureLoss}mbar/100m`;
            }
        }

        function getConnectionPosition(eq, side) {
            const centerX = eq.x + eq.width / 2;
            const centerY = eq.y + eq.height / 2;
            
            let x, y;
            switch(side) {
                case 'top': x = centerX; y = eq.y; break;
                case 'right': x = eq.x + eq.width; y = centerY; break;
                case 'bottom': x = centerX; y = eq.y + eq.height; break;
                case 'left': x = eq.x; y = centerY; break;
            }
            
            return { x, y };
        }

        function drawPipe(pipe) {
            const startEq = equipment.find(e => e.id === pipe.startEquipment);
            const endEq = equipment.find(e => e.id === pipe.endEquipment);
            
            if (!startEq || !endEq) return;
            
            const startPos = getConnectionPosition(startEq, pipe.startSide);
            const endPos = getConnectionPosition(endEq, pipe.endSide);
            
            const pipeElement = document.createElement('div');
            pipeElement.className = 'pipe';
            pipeElement.id = `pipe-${pipe.id}`;
            
            const length = Math.sqrt((endPos.x - startPos.x) ** 2 + (endPos.y - startPos.y) ** 2);
            const angle = Math.atan2(endPos.y - startPos.y, endPos.x - startPos.x);
            
            pipeElement.style.left = startPos.x + 'px';
            pipeElement.style.top = startPos.y + 'px';
            pipeElement.style.width = length + 'px';
            pipeElement.style.height = Math.max(2, pipe.diameter / 10) + 'px';
            pipeElement.style.transform = `rotate(${angle}rad)`;
            pipeElement.style.transformOrigin = '0 50%';
            pipeElement.style.backgroundColor = pipe.type === 'air' ? '#2d3748' : '#e53e3e';
            
            pipeElement.addEventListener('click', function() {
                selectPipe(pipe.id);
            });
            
            canvasContainer.appendChild(pipeElement);
        }

        function selectPipe(pipeId) {
            if (currentTool === 'select') {
                document.querySelectorAll('.pipe').forEach(p => p.classList.remove('selected'));
                const pipeEl = document.getElementById(`pipe-${pipeId}`);
                if (pipeEl) pipeEl.classList.add('selected');
                selectedPipes = [pipeId];
            }
        }

        function redrawPipesForEquipment(equipmentId) {
            pipes.forEach(pipe => {
                if (pipe.startEquipment === equipmentId || pipe.endEquipment === equipmentId) {
                    const element = document.getElementById(`pipe-${pipe.id}`);
                    if (element) element.remove();
                    drawPipe(pipe);
                }
            });
        }

        // Gestion des événements de souris
        function startDrag(e) {
            if (currentTool !== 'select') return;
            if (e.target.classList.contains('rotate-btn') || e.target.classList.contains('connection-point')) return;
            
            draggedItem = e.currentTarget;
            const rect = canvasContainer.getBoundingClientRect();
            draggedItem.offsetX = e.clientX - rect.left - draggedItem.offsetLeft;
            draggedItem.offsetY = e.clientY - rect.top - draggedItem.offsetTop;
            
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', stopDrag);
        }

        function drag(e) {
            if (!draggedItem) return;
            
            const rect = canvasContainer.getBoundingClientRect();
            let x = e.clientX - rect.left - draggedItem.offsetX;
            let y = e.clientY - rect.top - draggedItem.offsetY;
            
            x = Math.max(0, Math.min(x, canvas.width - draggedItem.offsetWidth));
            y = Math.max(0, Math.min(y, canvas.height - draggedItem.offsetHeight));
            
            draggedItem.style.left = x + 'px';
            draggedItem.style.top = y + 'px';
            
            const id = parseInt(draggedItem.id.replace('eq-', ''));
            const eq = equipment.find(e => e.id === id);
            if (eq) {
                eq.x = x;
                eq.y = y;
                redrawPipesForEquipment(id);
            }
        }

        function stopDrag() {
            draggedItem = null;
            document.removeEventListener('mousemove', drag);
            document.removeEventListener('mouseup', stopDrag);
        }

        // Variable pour stocker le point de mur sélectionné
        let selectedWallPoint = null;

        function handleEquipmentClick(e) {
            if (currentTool === 'measure') {
                const id = parseInt(e.currentTarget.id.replace('eq-', ''));
                const eq = equipment.find(e => e.id === id);
                
                if (selectedEquipment.includes(eq)) {
                    selectedEquipment = selectedEquipment.filter(s => s !== eq);
                    e.currentTarget.classList.remove('selected');
                } else {
                    selectedEquipment.push(eq);
                    e.currentTarget.classList.add('selected');
                }
                
                // Si on a un point de mur sélectionné et un équipement, mesurer la distance
                if (selectedWallPoint && selectedEquipment.length === 1) {
                    showWallToEquipmentDistance(selectedWallPoint, selectedEquipment[0]);
                    selectedWallPoint = null;
                    selectedEquipment = [];
                    document.querySelectorAll('.equipment-item').forEach(el => 
                        el.classList.remove('selected'));
                    removeWallPointVisual();
                } else if (selectedEquipment.length === 2) {
                    showDistance();
                    selectedEquipment = [];
                    document.querySelectorAll('.equipment-item').forEach(el => 
                        el.classList.remove('selected'));
                }
            } else if (currentTool === 'dimension') {
                const id = parseInt(e.currentTarget.id.replace('eq-', ''));
                const eq = equipment.find(e => e.id === id);
                
                if (selectedEquipment.includes(eq)) {
                    selectedEquipment = selectedEquipment.filter(s => s !== eq);
                    e.currentTarget.classList.remove('selected');
                } else {
                    selectedEquipment.push(eq);
                    e.currentTarget.classList.add('selected');
                }
                
                if (selectedEquipment.length === 2) {
                    showDimension();
                    selectedEquipment = [];
                    document.querySelectorAll('.equipment-item').forEach(el => 
                        el.classList.remove('selected'));
                }
            }
        }

        // Gestion des clics sur le canvas pour sélectionner les murs
        function handleCanvasClick(e) {
            if (currentTool !== 'measure') return;
            
            const rect = canvasContainer.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            // Vérifier si le clic est près d'un mur (tolérance de 10 pixels)
            const tolerance = 10;
            let wallPoint = null;
            
            // Mur gauche
            if (x <= tolerance) {
                wallPoint = { x: 0, y: y, wall: 'left', displayX: 0, displayY: y };
            }
            // Mur droit
            else if (x >= canvas.width - tolerance) {
                wallPoint = { x: canvas.width, y: y, wall: 'right', displayX: canvas.width, displayY: y };
            }
            // Mur haut
            else if (y <= tolerance) {
                wallPoint = { x: x, y: 0, wall: 'top', displayX: x, displayY: 0 };
            }
            // Mur bas
            else if (y >= canvas.height - tolerance) {
                wallPoint = { x: x, y: canvas.height, wall: 'bottom', displayX: x, displayY: canvas.height };
            }
            
            if (wallPoint) {
                selectedWallPoint = wallPoint;
                showWallPointVisual(wallPoint);
                
                const statusText = document.getElementById('statusText');
                if (statusText) statusText.textContent = 'Point de mur sélectionné - Cliquez sur un équipement';
            }
        }

        function showWallPointVisual(wallPoint) {
            // Supprimer l'ancien point visuel s'il existe
            removeWallPointVisual();
            
            const visual = document.createElement('div');
            visual.id = 'wall-point-visual';
            visual.style.position = 'absolute';
            visual.style.left = (wallPoint.displayX - 6) + 'px';
            visual.style.top = (wallPoint.displayY - 6) + 'px';
            visual.style.width = '12px';
            visual.style.height = '12px';
            visual.style.background = '#e53e3e';
            visual.style.border = '2px solid white';
            visual.style.borderRadius = '50%';
            visual.style.zIndex = '20';
            visual.style.boxShadow = '0 2px 8px rgba(229, 62, 62, 0.5)';
            
            canvasContainer.appendChild(visual);
        }

        function removeWallPointVisual() {
            const existing = document.getElementById('wall-point-visual');
            if (existing) existing.remove();
        }

        function showWallToEquipmentDistance(wallPoint, equipment) {
            // Calculer le point le plus proche de l'équipement au mur
            let equipmentPoint;
            const eqCenterX = equipment.x + equipment.width / 2;
            const eqCenterY = equipment.y + equipment.height / 2;
            
            switch(wallPoint.wall) {
                case 'left':
                    equipmentPoint = { x: equipment.x, y: eqCenterY };
                    break;
                case 'right':
                    equipmentPoint = { x: equipment.x + equipment.width, y: eqCenterY };
                    break;
                case 'top':
                    equipmentPoint = { x: eqCenterX, y: equipment.y };
                    break;
                case 'bottom':
                    equipmentPoint = { x: eqCenterX, y: equipment.y + equipment.height };
                    break;
            }
            
            // Calculer la distance
            const distance = Math.sqrt(
                (equipmentPoint.x - wallPoint.x) ** 2 + 
                (equipmentPoint.y - wallPoint.y) ** 2
            ) / scale;
            
            // Créer la ligne de mesure
            const line = document.createElement('div');
            line.className = 'distance-line';
            line.style.left = Math.min(wallPoint.displayX, equipmentPoint.x) + 'px';
            line.style.top = Math.min(wallPoint.displayY, equipmentPoint.y) + 'px';
            line.style.width = Math.sqrt(
                (equipmentPoint.x - wallPoint.displayX) ** 2 + 
                (equipmentPoint.y - wallPoint.displayY) ** 2
            ) + 'px';
            line.style.transform = `rotate(${Math.atan2(
                equipmentPoint.y - wallPoint.displayY, 
                equipmentPoint.x - wallPoint.displayX
            )}rad)`;
            line.style.borderColor = '#ff6b35'; // Couleur différente pour les mesures mur-équipement
            
            // Créer le label
            const label = document.createElement('div');
            label.className = 'distance-label';
            label.style.left = ((wallPoint.displayX + equipmentPoint.x) / 2) + 'px';
            label.style.top = ((wallPoint.displayY + equipmentPoint.y) / 2) + 'px';
            label.style.transform = 'translate(-50%, -50%)';
            label.style.background = 'rgba(255, 107, 53, 0.9)'; // Couleur assortie
            label.textContent = distance.toFixed(2) + ' m';
            
            canvasContainer.appendChild(line);
            canvasContainer.appendChild(label);
            
            const statusText = document.getElementById('statusText');
            if (statusText) statusText.textContent = `Distance au mur: ${distance.toFixed(2)}m`;
        }

        // Fonctions de mesure et cotation
        function showDistance() {
            const [eq1, eq2] = selectedEquipment;
            
            const x1 = eq1.x + eq1.width / 2;
            const y1 = eq1.y + eq1.height / 2;
            const x2 = eq2.x + eq2.width / 2;
            const y2 = eq2.y + eq2.height / 2;
            
            let halfWidth1, halfHeight1, halfWidth2, halfHeight2;
            
            if (eq1.rotation === 90 || eq1.rotation === 270) {
                halfWidth1 = eq1.height / 2;
                halfHeight1 = eq1.width / 2;
            } else {
                halfWidth1 = eq1.width / 2;
                halfHeight1 = eq1.height / 2;
            }
            
            if (eq2.rotation === 90 || eq2.rotation === 270) {
                halfWidth2 = eq2.height / 2;
                halfHeight2 = eq2.width / 2;
            } else {
                halfWidth2 = eq2.width / 2;
                halfHeight2 = eq2.height / 2;
            }
            
            let point1, point2;
            
            if (x2 < x1 - halfWidth1) {
                point1 = { x: x1 - halfWidth1, y: y1 };
            } else if (x2 > x1 + halfWidth1) {
                point1 = { x: x1 + halfWidth1, y: y1 };
            } else if (y2 < y1 - halfHeight1) {
                point1 = { x: x1, y: y1 - halfHeight1 };
            } else if (y2 > y1 + halfHeight1) {
                point1 = { x: x1, y: y1 + halfHeight1 };
            } else {
                point1 = { x: x1, y: y1 };
            }
            
            if (x1 < x2 - halfWidth2) {
                point2 = { x: x2 - halfWidth2, y: y2 };
            } else if (x1 > x2 + halfWidth2) {
                point2 = { x: x2 + halfWidth2, y: y2 };
            } else if (y1 < y2 - halfHeight2) {
                point2 = { x: x2, y: y2 - halfHeight2 };
            } else if (y1 > y2 + halfHeight2) {
                point2 = { x: x2, y: y2 + halfHeight2 };
            } else {
                point2 = { x: x2, y: y2 };
            }
            
            if (Math.abs(point1.y - point2.y) < 5) {
                if (point1.x < point2.x) {
                    point1.x = x1 + halfWidth1;
                    point2.x = x2 - halfWidth2;
                } else {
                    point1.x = x1 - halfWidth1;
                    point2.x = x2 + halfWidth2;
                }
                point1.y = point2.y = (point1.y + point2.y) / 2;
            } else if (Math.abs(point1.x - point2.x) < 5) {
                if (point1.y < point2.y) {
                    point1.y = y1 + halfHeight1;
                    point2.y = y2 - halfHeight2;
                } else {
                    point1.y = y1 - halfHeight1;
                    point2.y = y2 + halfHeight2;
                }
                point1.x = point2.x = (point1.x + point2.x) / 2;
            }
            
            const distance = Math.sqrt((point2.x - point1.x) ** 2 + (point2.y - point1.y) ** 2) / scale;
            
            const line = document.createElement('div');
            line.className = 'distance-line';
            line.style.left = point1.x + 'px';
            line.style.top = point1.y + 'px';
            line.style.width = Math.sqrt((point2.x - point1.x) ** 2 + (point2.y - point1.y) ** 2) + 'px';
            line.style.transform = `rotate(${Math.atan2(point2.y - point1.y, point2.x - point1.x)}rad)`;
            
            const label = document.createElement('div');
            label.className = 'distance-label';
            label.style.left = ((point1.x + point2.x) / 2) + 'px';
            label.style.top = ((point1.y + point2.y) / 2) + 'px';
            label.style.transform = 'translate(-50%, -50%)';
            label.textContent = distance.toFixed(2) + ' m';
            
            canvasContainer.appendChild(line);
            canvasContainer.appendChild(label);
        }

        function showDimension() {
            const [eq1, eq2] = selectedEquipment;
            
            const x1 = eq1.x + eq1.width / 2;
            const y1 = eq1.y + eq1.height / 2;
            const x2 = eq2.x + eq2.width / 2;
            const y2 = eq2.y + eq2.height / 2;
            
            const distance = Math.sqrt((x2 - x1) ** 2 + (y2 - y1) ** 2) / scale;
            
            const line = document.createElement('div');
            line.className = 'dimension-line';
            line.style.left = Math.min(x1, x2) + 'px';
            line.style.top = Math.min(y1, y2) - 20 + 'px';
            line.style.width = Math.abs(x2 - x1) + 'px';
            
            const label = document.createElement('div');
            label.className = 'dimension-label';
            label.style.left = ((x1 + x2) / 2) + 'px';
            label.style.top = Math.min(y1, y2) - 20 + 'px';
            label.textContent = distance.toFixed(2) + ' m';
            
            canvasContainer.appendChild(line);
            canvasContainer.appendChild(label);
        }

        // Fonctions de mise à jour des listes
        function updateEquipmentList() {
            const list = document.getElementById('equipmentList');
            if (!list) return;
            list.innerHTML = '';
            
            equipment.forEach(eq => {
                const div = document.createElement('div');
                div.style.display = 'flex';
                div.style.alignItems = 'center';
                div.style.marginBottom = '10px';
                div.style.padding = '10px';
                div.style.background = '#f7fafc';
                div.style.borderRadius = '6px';
                
                const x = (eq.x / scale).toFixed(1);
                const y = (eq.y / scale).toFixed(1);
                const rotation = eq.rotation || 0;
                
                let specs = `${eq.widthMm}×${eq.depthMm}mm - ${rotation}°`;
                if (eq.type === 'compresseur') {
                    specs += ` - ${eq.flow}m³/h`;
                } else if (eq.type === 'reservoir') {
                    specs += ` - ${eq.capacity}L`;
                } else {
                    specs += ` - Traitement`;
                }
                
                div.innerHTML = `
                    <span style="flex: 1;">${eq.name} (${eq.type}) - ${x}m, ${y}m - ${specs}</span>
                    <button class="delete-btn" onclick="removeEquipment(${eq.id})">Supprimer</button>
                `;
                
                list.appendChild(div);
            });
        }

        function updatePipesList() {
            const list = document.getElementById('pipesList');
            if (!list) return;
            list.innerHTML = '';
            
            pipes.forEach(pipe => {
                const startEq = equipment.find(e => e.id === pipe.startEquipment);
                const endEq = equipment.find(e => e.id === pipe.endEquipment);
                
                const div = document.createElement('div');
                div.style.display = 'flex';
                div.style.alignItems = 'center';
                div.style.marginBottom = '10px';
                div.style.padding = '10px';
                div.style.background = '#f7fafc';
                div.style.borderRadius = '6px';
                
                const materialName = {
                    'galvanise': 'Galva',
                    'airnet': 'AIRnet',
                    'inox': 'Inox'
                }[pipe.material] || pipe.material;
                
                div.innerHTML = `
                    <span style="flex: 1;">${startEq?.name} → ${endEq?.name}<br>
                    <small>Ø${pipe.diameter}mm ${materialName} - ${pipe.length.toFixed(1)}m - ${pipe.velocity}m/s - ${pipe.pressureLoss}mbar/100m</small></span>
                    <button class="delete-btn" onclick="removePipe(${pipe.id})">Supprimer</button>
                `;
                
                list.appendChild(div);
            });
        }

        function updateCalculations() {
            const totalArea = equipment.reduce((sum, eq) => 
                sum + (eq.widthMm * eq.depthMm / 1000000), 0);
            const compressorFlow = getCompressorFlow();
            const totalStorage = equipment
                .filter(eq => eq.type === 'reservoir')
                .reduce((sum, eq) => sum + (eq.capacity || 0), 0);
            const totalPipeLength = pipes.reduce((sum, pipe) => sum + pipe.length, 0);
            
            const elements = {
                'totalArea': totalArea.toFixed(2) + ' m²',
                'totalCompressorFlow': compressorFlow + ' m³/h',
                'totalStorage': totalStorage + ' L',
                'totalPipeLength': totalPipeLength.toFixed(1) + ' m',
                'equipmentCount': equipment.length
            };
            
            Object.entries(elements).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element) element.textContent = value;
            });
        }

        // Fonctions de nettoyage
        function redrawAll() {
            equipment.forEach(eq => {
                const element = document.getElementById(`eq-${eq.id}`);
                if (element) element.remove();
                
                eq.width = (eq.widthMm / 1000) * scale;
                eq.height = (eq.depthMm / 1000) * scale;
                if (eq.rotation === undefined) eq.rotation = 0;
                
                createEquipmentElement(eq);
            });
            
            pipes.forEach(pipe => {
                const element = document.getElementById(`pipe-${pipe.id}`);
                if (element) element.remove();
                drawPipe(pipe);
            });
        }

        function removeEquipment(id) {
            equipment = equipment.filter(eq => eq.id !== id);
            pipes = pipes.filter(pipe => 
                pipe.startEquipment !== id && pipe.endEquipment !== id);
            
            const element = document.getElementById(`eq-${id}`);
            if (element) element.remove();
            
            document.querySelectorAll('.pipe').forEach(pipeEl => {
                const pipeId = parseInt(pipeEl.id.replace('pipe-', ''));
                const pipe = pipes.find(p => p.id === pipeId);
                if (!pipe) pipeEl.remove();
            });
            
            redrawAll();
            updateEquipmentList();
            updatePipesList();
            updateCalculations();
        }

        function removePipe(id) {
            pipes = pipes.filter(pipe => pipe.id !== id);
            const element = document.getElementById(`pipe-${id}`);
            if (element) element.remove();
            updatePipesList();
            updateCalculations();
        }

        function clearAll() {
            equipment = [];
            pipes = [];
            document.querySelectorAll('.equipment-item, .pipe').forEach(el => el.remove());
            clearDistances();
            clearDimensions();
            updateEquipmentList();
            updatePipesList();
            updateCalculations();
        }

        function clearPipes() {
            pipes = [];
            document.querySelectorAll('.pipe').forEach(el => el.remove());
            updatePipesList();
            updateCalculations();
        }

        function clearDistances() {
            document.querySelectorAll('.distance-line, .distance-label').forEach(el => el.remove());
            removeWallPointVisual();
            selectedWallPoint = null;
        }

        function clearDimensions() {
            document.querySelectorAll('.dimension-line, .dimension-label').forEach(el => el.remove());
        }

        // Fonctions utilitaires
        function snapToGrid() {
            equipment.forEach(eq => {
                const gridSize = scale / 2;
                eq.x = Math.round(eq.x / gridSize) * gridSize;
                eq.y = Math.round(eq.y / gridSize) * gridSize;
            });
            redrawAll();
            updateEquipmentList();
        }

        function optimizeLayout() {
            equipment.sort((a, b) => (b.flow || 0) - (a.flow || 0));
            
            let currentX = 50;
            let currentY = 50;
            let rowHeight = 0;
            
            equipment.forEach(eq => {
                if (currentX + eq.width > canvas.width - 50) {
                    currentX = 50;
                    currentY += rowHeight + 50;
                    rowHeight = 0;
                }
                
                eq.x = currentX;
                eq.y = currentY;
                currentX += eq.width + 50;
                rowHeight = Math.max(rowHeight, eq.height);
            });
            
            redrawAll();
            updateEquipmentList();
        }

        // Fonctions de sauvegarde et chargement
        function saveProject() {
            project.equipment = equipment;
            project.pipes = pipes;
            project.modified = new Date();
            
            const dataStr = JSON.stringify(project, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'plan_compresseur.json';
            link.click();
            URL.revokeObjectURL(url);
            
            const statusText = document.getElementById('statusText');
            if (statusText) statusText.textContent = 'Projet sauvegardé';
        }

        function loadProject() {
            const fileInput = document.getElementById('fileInput');
            if (fileInput) fileInput.click();
        }

        function handleFileLoad(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const loadedProject = JSON.parse(e.target.result);
                    clearAll();
                    
                    equipment = loadedProject.equipment || [];
                    pipes = loadedProject.pipes || [];
                    project = loadedProject;
                    
                    redrawAll();
                    updateEquipmentList();
                    updatePipesList();
                    updateCalculations();
                    
                    const statusText = document.getElementById('statusText');
                    if (statusText) statusText.textContent = 'Projet chargé';
                } catch (error) {
                    alert('Erreur lors du chargement du fichier');
                }
            };
            reader.readAsText(file);
        }

        function exportPDF() {
            alert('Fonctionnalité PDF en cours de développement\nLe plan sera exporté en haute qualité avec tous les éléments sélectionnés.');
        }

        function showCalculations() {
            showTab('calculations');
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
            
            const tabs = document.querySelectorAll('.tab');
            const tabIndex = tabName === 'equipment' ? 0 : tabName === 'pipes' ? 1 : 2;
            if (tabs[tabIndex]) tabs[tabIndex].classList.add('active');
            
            const tabContent = document.getElementById(tabName + 'Tab');
            if (tabContent) tabContent.style.display = 'block';
        }

        // Gestion des événements et initialisation
        function initializeEventListeners() {
            const equipmentType = document.getElementById('equipmentType');
            const flowRow = document.getElementById('flowRow');
            const capacityRow = document.getElementById('capacityRow');
            const equipmentFlow = document.getElementById('equipmentFlow');
            const equipmentCapacity = document.getElementById('equipmentCapacity');
            
            if (equipmentType && flowRow && capacityRow) {
                equipmentType.addEventListener('change', function() {
                    const type = this.value;
                    
                    if (type === 'compresseur') {
                        flowRow.style.display = 'flex';
                        capacityRow.style.display = 'none';
                        if (equipmentFlow) equipmentFlow.value = 500;
                    } else if (type === 'reservoir') {
                        flowRow.style.display = 'none';
                        capacityRow.style.display = 'flex';
                        if (equipmentCapacity) equipmentCapacity.value = 500;
                    } else {
                        flowRow.style.display = 'none';
                        capacityRow.style.display = 'none';
                    }

                    const equipmentWidth = document.getElementById('equipmentWidth');
                    const equipmentDepth = document.getElementById('equipmentDepth');
                    if (type === 'coude' || type === 'tee') {
                        if (equipmentWidth) equipmentWidth.value = 100;
                        if (equipmentDepth) equipmentDepth.value = 100;
                    }
                });
            }
        }

        function initializeMouseTracking() {
            if (canvasContainer) {
                canvasContainer.addEventListener('mousemove', function(e) {
                    const rect = canvasContainer.getBoundingClientRect();
                    const x = ((e.clientX - rect.left) / scale).toFixed(1);
                    const y = ((e.clientY - rect.top) / scale).toFixed(1);
                    const mousePosElement = document.getElementById('mousePos');
                    if (mousePosElement) {
                        mousePosElement.textContent = `Position: ${x},${y} m`;
                    }
                });
                
                // Ajouter l'événement de clic sur le canvas pour les mesures de mur
                canvasContainer.addEventListener('click', handleCanvasClick);
            }
        }

        // Initialisation principale
        document.addEventListener('DOMContentLoaded', function() {
            initializeEventListeners();
            initializeMouseTracking();
            setTool('select');
            updateCanvasSize();
            drawRoom();
            updateCalculations();
            
            // Initialiser l'affichage des champs selon le type d'équipement
            const equipmentType = document.getElementById('equipmentType');
            if (equipmentType) {
                equipmentType.dispatchEvent(new Event('change'));
            }
        });
    </script>
</body>
</html>
